{% extends "base.html" %}
{% block content %}
<h2>Finishing Rules</h2>

<!-- Help Section -->
<div class="help-section">
    <h3>Understanding Finishing Rules</h3>
    <div class="rule-explanation">
        <div class="rule-box">
            <h4>Keyword Rules</h4>
            <p><strong>Include Keywords:</strong> The product description must contain at least one (or all, depending on Match Type) of the specified keywords.<br>
               <strong>Exclude Keywords:</strong> The product description must NOT contain any of the specified keywords.</p>
            <p class="example">Example: Add days for "fold", "crease", unless "digital" is present.</p>
        </div>
        <div class="rule-box">
            <h4>Conditions</h4>
            <p>Further criteria like quantity, product ID, etc., that must ALL be met for the rule to apply.</p>
            <p class="example">Example: Add days only if Qty > 10,000 AND Product ID is 15.</p>
        </div>
        <div class="rule-box">
            <h4>Center Rules</h4>
            <p>Specific rules that only apply if the order is processed at a particular center/hub ID.</p>
            <p class="example">Example: Center ID 3 adds 1 day if description excludes "express".</p>
        </div>
        <div class="rule-box">
            <h4>Days Added</h4>
            <p>The number of extra production days if this specific rule matches.</p>
            <p class="example">Example: +1 day.</p>
        </div>
        <div class="rule-box">
            <h4>Evaluation</h4>
            <p>All active rules are checked. Multiple rules can apply, and their 'Days Added' values are summed up for the total finishing days.</p>
            <p class="example">Example: A folding rule (+1) and a high quantity rule (+1) results in +2 days total.</p>
        </div>
    </div>
</div>

<button onclick="showAddForm()" class="add-btn">Add New Rule</button>

<!-- Rules Tables -->
<div id="rulesContainer" class="rules-container">
    <h3 class="section-title">Keyword Rules</h3>
    <table class="rules-table">
        <thead>
             <tr>
                 <th>ID</th>
                 <th>Description</th>
                 <th>Include Keywords</th>
                 <th>Exclude Keywords</th>
                 <th>Match Type</th>
                 <th>Days Added</th>
                 <th>Conditions</th>
                 <th>Status</th>
                 <th>Actions</th>
             </tr>
             <tr class="filter-row">
                 <th><input type="text" class="column-filter" data-column="0" placeholder="Filter ID..."></th>
                 <th><input type="text" class="column-filter" data-column="1" placeholder="Filter Desc..."></th>
                 <th><input type="text" class="column-filter" data-column="2" placeholder="Filter Include..."></th>
                 <th><input type="text" class="column-filter" data-column="3" placeholder="Filter Exclude..."></th>
                 <th><input type="text" class="column-filter" data-column="4" placeholder="Filter Type..."></th>
                 <th><input type="text" class="column-filter" data-column="5" placeholder="Filter Days..."></th>
                 <th><input type="text" class="column-filter" data-column="6" placeholder="Filter Cond..."></th>
                 <th><input type="text" class="column-filter" data-column="7" placeholder="Filter Status..."></th>
                 <th></th> <!-- Empty header for actions filter -->
             </tr>
        </thead>
        <tbody id="keywordRulesBody">
            {% for rule in rules.keywordRules %}
            <tr>
                <td>{{ rule.id }}</td>
                <td>{{ rule.description }}</td>
                <td>{{ rule.keywords|join(", ") if rule.keywords else "N/A" }}</td>
                <td>{{ rule.excludeKeywords|join(", ") if rule.excludeKeywords else "N/A" }}</td>
                <td>{{ rule.matchType|default('any')|capitalize }}</td>
                <td>{{ rule.addDays }}</td>
                <td>
                    {% if rule.conditions %}
                    <ul class="conditions-list">
                        {% for key, value in rule.conditions.items() %}
                            {% if key == 'hubOverrides' %}
                                <li>Hub Overrides: <pre style="margin: 0; display: inline;">{{ value|tojson|indent(4) }}</pre></li>
                            {% elif key == 'productionHubIs' %}
                                <li>Production Hub Is: {{ value|join(", ") }}</li> {# Display hub list #}
                            {% elif key == 'productIdIn' %}
                                <li>Product ID In: {{ value|join(", ") }}</li> {# Display product ID list #}
                            {% elif key != 'hubOverrides' %} {# Generic display for others #}
                                <li>{{ key }}: {{ value }}</li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                    {% else %}
                    None
                    {% endif %}
                </td>
                <td><span class="status-{{ "active" if rule.enabled else "disabled" }}">{{ "Active" if rule.enabled else "Disabled" }}</span></td>
                <td>
                    <button type="button" class="edit-btn" data-rule-id="{{ rule.id }}">Edit</button>
                    <button type="button" class="delete-btn" data-rule-id="{{ rule.id }}">Delete</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h3 class="section-title">Center Rules</h3>
    <table class="rules-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Description</th>
                <th>Center ID</th>
                <th>Exclude Keywords</th>
                <th>Days Added</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
            <tr class="filter-row">
                <th><input type="text" class="column-filter" data-column="0" placeholder="Filter ID..."></th>
                <th><input type="text" class="column-filter" data-column="1" placeholder="Filter Desc..."></th>
                <th><input type="text" class="column-filter" data-column="2" placeholder="Filter Center..."></th>
                <th><input type="text" class="column-filter" data-column="3" placeholder="Filter Exclude..."></th>
                <th><input type="text" class="column-filter" data-column="4" placeholder="Filter Days..."></th>
                <th><input type="text" class="column-filter" data-column="5" placeholder="Filter Status..."></th>
                <th></th> <!-- Empty header for actions filter -->
            </tr>
        </thead>
        <tbody id="centerRulesBody">
            {% for rule in rules.centerRules %}
            <tr>
                <td>{{ rule.id }}</td>
                <td>{{ rule.description }}</td>
                <td>{{ rule.centerId }}</td>
                <td>{{ rule.excludeKeywords|join(", ") if rule.excludeKeywords else "N/A" }}</td>
                <td>{{ rule.addDays }}</td>
                <td><span class="status-{{ "active" if rule.enabled else "disabled" }}">{{ "Active" if rule.enabled else "Disabled" }}</span></td>
                <td>
                    <button type="button" class="edit-btn center-edit-btn" data-rule-id="{{ rule.id }}">Edit</button>
                    <button type="button" class="delete-btn center-delete-btn" data-rule-id="{{ rule.id }}">Delete</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Rule Editor Modal -->
<div id="ruleEditor" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">Add/Edit Rule</h3>

        <!-- Rule Type & Basic Info -->
        <div class="form-section">
            <h4>Rule Type & Basic Info</h4>
            <div class="form-group">
                <label for="ruleType">Rule Type:</label>
                <select id="ruleType" class="form-control" onchange="toggleRuleFields()">
                    <option value="keyword">Keyword Rule</option>
                    <option value="center">Center Rule</option>
                </select>
            </div>
            <div class="form-group">
                <label for="ruleId">Rule ID:</label>
                <input type="text" id="ruleId" required class="form-control">
                <small>Unique identifier for this rule (e.g., "FOLDING_EXTRA_DAY"). Cannot be changed after creation easily.</small>
            </div>
            <div class="form-group">
                <label for="description">Description:</label>
                <input type="text" id="description" required class="form-control">
                <small>Human-readable explanation of what the rule does.</small>
            </div>
        </div>

        <!-- Keyword Rule Specific Fields -->
        <div id="keywordFields" class="form-section">
            <h4>Keyword Matching</h4>
            <div class="form-group">
                <label>Keywords to Include:</label>
                <div class="dynamic-container">
                    <input type="text" id="keywordInput" placeholder="Type keyword and press Enter" class="tag-input">
                    <div id="keywordTags" class="tag-container"></div>
                </div>
                <small>Rule applies if description contains ANY (default) or ALL of these keywords.</small>
            </div>

            <div class="form-group">
                <label>Keywords to Exclude:</label>
                <div class="dynamic-container">
                    <input type="text" id="excludeKeywordInput" placeholder="Type keyword and press Enter" class="tag-input">
                    <div id="excludeKeywordTags" class="tag-container"></div>
                </div>
                <small>Rule does NOT apply if description contains ANY of these keywords.</small>
            </div>

            <div class="form-group">
                <label for="matchType">Include Keyword Match Type:</label>
                <select id="matchType" class="form-control">
                    <option value="any">Match Any Keyword (OR)</option>
                    <option value="all">Match All Keywords (AND)</option>
                </select>
                <small>Determines if any or all 'Include Keywords' must be present.</small>
            </div>
        </div>

        <!-- Center Rule Specific Fields -->
        <div id="centerFields" class="form-section" style="display: none;">
            <h4>Center Matching</h4>
             <div class="form-group">
                 <label for="centerId">Center/Hub ID:</label>
                 <input type="number" id="centerId" class="form-control">
                 <small>The specific MIS Hub ID this rule applies to (e.g., 1 for VIC, 3 for WA).</small>
             </div>
             <div class="form-group">
                 <label>Keywords to Exclude (for Center Rule):</label>
                 <div class="dynamic-container">
                     <input type="text" id="centerExcludeKeywordInput" placeholder="Type keyword and press Enter" class="tag-input">
                     <div id="centerExcludeKeywordTags" class="tag-container"></div>
                 </div>
                 <small>Center rule does NOT apply if description contains ANY of these keywords.</small>
             </div>
        </div>

        <!-- Conditions (Keyword Rules Only) -->
        <div id="conditionsSection" class="form-section">
             <h4>Additional Conditions (All must be met)</h4>
             <div class="form-group">
                <div id="conditionsContainer" class="conditions-container">
                    <!-- Condition rows dynamically added here -->
                </div>
                <button onclick="addConditionRow()" type="button" class="action-btn add-btn">
                    <i class="fas fa-plus"></i> Add Condition
                </button>
                <small>These conditions only apply to 'Keyword' type rules.</small>
             </div>
        </div>

        <!-- Common Fields -->
        <div class="form-section">
            <h4>Rule Action & Status</h4>
            <div class="form-group">
                <label for="addDays">Days to Add:</label>
                <input type="number" id="addDays" required class="form-control">
                <small>Number of extra production days to add if this rule matches.</small>
            </div>
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="enabled" checked>
                    Rule Enabled
                </label>
                <small>Uncheck to disable this rule without deleting it.</small>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="button-group">
            <button onclick="saveRule()" class="primary-btn save-btn">Save Rule</button>
            <button onclick="closeEditor()" class="secondary-btn cancel-btn">Cancel</button>
        </div>
    </div>
</div>

<style>
    /* General Layout & Help Section */
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"; line-height: 1.5; color: #212529; background-color: #fff; }
    h2, h3 { color: #343a40; }
    .btn { text-decoration: none; padding: 0.375rem 0.75rem; background-color: #0d6efd; color: white; border-radius: 0.25rem; margin-right: 0.5rem; display: inline-block; font-size: 1rem; text-align: center; vertical-align: middle; user-select: none; border: 1px solid transparent; }
    .btn:hover { background-color: #0b5ed7; }
    .help-section { background: #f8f9fa; padding: 1.25rem; margin-bottom: 1.5rem; border-radius: 0.3rem; border: 1px solid #dee2e6;}
    .rule-explanation { display: flex; gap: 1.25rem; margin-top: 1rem; flex-wrap: wrap; }
    .rule-box { flex: 1 1 220px; background: white; padding: 1rem; border-radius: 0.3rem; box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); border: 1px solid #eee; }
    .rule-box h4 { color: #0d6efd; margin-top: 0; margin-bottom: 0.5rem; font-size: 1.1em; }
    .example { font-style: italic; color: #6c757d; font-size: 0.875em; margin-top: 0.5rem;}

    /* Standardized Add Button */
    .add-btn {
        background: #6c7b7d;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 500;
        transition: all 0.2s ease-in-out;
        margin-bottom: 1.25rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    .add-btn:hover {
        background: #5a6268;
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }

    /* Tables */
    .rules-container { padding: 0 5px; }
    .section-title { color: #495057; margin-top: 2rem; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #dee2e6; font-size: 1.4em; font-weight: 500; }
    .rules-table { width: 100%; margin-bottom: 2rem; border-collapse: collapse; }
    .rules-table th, .rules-table td { padding: 12px; text-align: left; border: 1px solid #ddd; vertical-align: top; }
    .rules-table th { background: #f8f9fa; }
    .rules-table tbody tr:hover { background-color: #f8f9fa; }
    .conditions-list { list-style: none; margin: 0; padding: 0; font-size: 0.85em; }
    .conditions-list li { margin-bottom: 0.25rem; word-break: break-word; }
    .conditions-list pre { background-color: #e9ecef; padding: 0.25rem 0.5rem; border-radius: 0.2rem; font-size: 0.9em; }
    .status-active { color: #198754; font-weight: bold; }
    .status-disabled { color: #dc3545; }
    .filter-row input { width: calc(100% - 16px); padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em; margin: 4px 8px; box-sizing: border-box; }
    .filter-row input:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 2px rgba(0,123,255,0.25); }
    .filter-row th { padding: 4px 12px; background: #f1f3f5; }

    /* Table action buttons */
.rules-table .edit-btn {
    background-image: linear-gradient(#f7f8fa ,#e7e9ec);
    border-color: #adb1b8 #a2a6ac #8d9096;
    border-style: solid;
    border-width: 1px;
    border-radius: 3px;
    box-shadow: rgba(255,255,255,.6) 0 1px 0 inset;
    box-sizing: border-box;
    color: #000000;
    cursor: pointer;
    display: inline-block;
    font-family: "Amazon Ember",Arial,sans-serif;
    font-size: 13px;
    height: 29px;
    outline: 0;
    overflow: hidden;
    padding: 0 11px;
    text-align: center;
    text-decoration: none;
    text-overflow: ellipsis;
    user-select: none;
    -webkit-user-select: none;
    touch-action: manipulation;
    white-space: nowrap;
    margin-right: 5px;
}
.rules-table .delete-btn {
    background-image: linear-gradient(#f7f8fa ,#e7e9ec);
    border-color: #adb1b8 #a2a6ac #8d9096;
    border-style: solid;
    border-width: 1px;
    border-radius: 3px;
    box-shadow: rgba(255,255,255,.6) 0 1px 0 inset;
    box-sizing: border-box;
    color: #8B0000;
    cursor: pointer;
    display: inline-block;
    font-family: "Amazon Ember",Arial,sans-serif;
    font-size: 13px;
    height: 29px;
    outline: 0;
    overflow: hidden;
    padding: 0 11px;
    text-align: center;
    text-decoration: none;
    text-overflow: ellipsis;
    user-select: none;
    -webkit-user-select: none;
    touch-action: manipulation;
    white-space: nowrap;
}
.rules-table .edit-btn:active {
    border-bottom-color: #a2a6ac;
}
.rules-table .edit-btn:active:hover {
    border-bottom-color: #a2a6ac;
}
.rules-table .edit-btn:hover {
    border-color: #a2a6ac #979aa1 #82858a;
    background-image: linear-gradient(#f0f8f0, #e8f5e8);
}
.rules-table .edit-btn:focus {
    border-color: #e77600;
    box-shadow: rgba(228, 121, 17, .5) 0 0 3px 2px;
    outline: 0;
}
.rules-table .delete-btn:active {
    border-bottom-color: #a2a6ac;
}
.rules-table .delete-btn:active:hover {
    border-bottom-color: #a2a6ac;
}
.rules-table .delete-btn:hover {
    border-color: #a2a6ac #979aa1 #82858a;
    background-image: linear-gradient(#fdf0f0, #f8e8e8);
}
.rules-table .delete-btn:focus {
    border-color: #e77600;
    box-shadow: rgba(228, 121, 17, .5) 0 0 3px 2px;
    outline: 0;
}

    /* Modal Base */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow-y: auto; z-index: 1000; }
    .modal-content { background: #ffffff; border-radius: 0.5rem; padding: 1.5rem 2rem; width: 90%; max-width: 800px; margin: 2.5rem auto; box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15); max-height: 90vh; overflow-y: auto; position: relative; }
    .modal-content h3 { color: #0a58ca; margin-top: 0; margin-bottom: 1.5rem; text-align: center; font-weight: 500; }

    /* Modal Form Styling */
    .form-section { background: #f8f9fa; border-radius: 0.3rem; padding: 1.25rem 1.5rem; margin-bottom: 1.5rem; border: 1px solid #dee2e6; }
    .form-section h4 { color: #495057; margin: 0 0 1rem 0; padding-bottom: 0.6rem; border-bottom: 1px solid #dee2e6; font-size: 1.1em; font-weight: 600; }
    .form-group { margin-bottom: 1rem; }
    .form-group:last-child { margin-bottom: 0; }
    .form-group label { display: block; font-weight: 500; margin-bottom: 0.4rem; color: #495057; font-size: 0.9rem; }
    .form-group label.checkbox-label { display: flex; align-items: center; gap: 0.5rem; font-weight: normal; }
    .form-group input[type="checkbox"] { width: 1rem; height: 1rem; accent-color: #0d6efd; }
    .form-group small { display: block; color: #6c757d; margin-top: 0.3rem; font-size: 0.8rem; }
    .form-control, .tag-input, select { width: 100%; padding: 0.5rem 0.75rem; font-size: 0.95rem; border: 1px solid #ced4da; border-radius: 0.25rem; transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; box-sizing: border-box; background-color: #fff; }
    select.form-control, select { appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 16px 12px; padding-right: 2.5rem; }
    .form-control:focus, .tag-input:focus, select:focus { border-color: #86b7fe; outline: 0; box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); }

    /* Tag Input Area */
    .dynamic-container { background: #ffffff; border: 1px solid #ced4da; border-radius: 0.25rem; padding: 0.75rem; margin-top: 0.5rem; }
    .tag-input { margin-bottom: 0.6rem; }
    .tag-container { min-height: 38px; display: flex; flex-wrap: wrap; gap: 0.4rem; }
    .tag { display: inline-flex; align-items: center; background: #e9ecef; padding: 0.25rem 0.6rem; border-radius: 0.2rem; font-size: 0.85em; gap: 0.3rem; border: 1px solid #ced4da; }
    .tag .remove { color: #dc3545; cursor: pointer; font-weight: bold; font-size: 1.1em; line-height: 1; }
    .tag .remove:hover { color: #a71d2a; }

    /* Conditions Area */
    .conditions-container { display: flex; flex-direction: column; gap: 0.6rem; }
    .condition-row { display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem; padding: 0.6rem; background: #fff; border: 1px solid #dee2e6; border-radius: 0.25rem; }
    .condition-type { flex: 1 1 160px; min-width: 140px; }
    .condition-value { flex: 1 1 100px; min-width: 80px; }
    .action-btn.add-btn {
        background: #6c7b7d;
        color: white;
        padding: 0.4rem 0.8rem;
        font-size: 0.85em;
        margin-top: 0.5rem;
        border: none;
        border-radius: 0.375rem;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    .action-btn.add-btn:hover {
        background: #5a6268;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
    }
    .condition-row .delete-btn { background: #dc3545; color: white; padding: 0.3rem 0.6rem; font-size: 0.8em; border: none; border-radius: 0.2rem; cursor: pointer;}
    .condition-row .delete-btn:hover { background: #c82333; }

    /* Modal Buttons */
    .button-group { display: flex; justify-content: flex-end; gap: 0.6rem; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #dee2e6; }
    .primary-btn, .secondary-btn { padding: 0.5rem 1rem; font-size: 0.95em; font-weight: 500; border-radius: 0.25rem; cursor: pointer; border: none; transition: all 0.15s ease-in-out; }
    .primary-btn { background: #0d6efd; color: white; }
    .primary-btn:hover { background: #0b5ed7; }
    .secondary-btn { background: #6c757d; color: white; }
    .secondary-btn:hover { background: #5c636a; }
    /* Alias save/cancel to primary/secondary */
    .save-btn { background: #0d6efd; color: white; } .save-btn:hover { background: #0b5ed7; }
    .cancel-btn { background: #6c757d; color: white; } .cancel-btn:hover { background: #5c636a; }

    /* Responsive */
    @media (max-width: 768px) {
        .modal-content { width: 95%; padding: 1.25rem 1.5rem; margin: 1.5rem auto; }
        .form-section { padding: 1rem; }
        .rule-explanation { flex-direction: column; }
        .condition-row { flex-direction: column; align-items: stretch; }
        .condition-type, .condition-value { width: 100%; }
        .button-group { flex-direction: column; gap: 0.5rem; }
        .primary-btn, .secondary-btn { width: 100%; }
    }
</style>

<script>
    // Store rules in a JS variable passed from Flask/Jinja
    let currentRules = {{ rules|tojson }};
    let editingRuleId = null; // Track if we are editing vs adding

    // --- DOMContentLoaded Listener ---
    document.addEventListener('DOMContentLoaded', function() {
        // Attach filter listeners
        const filterInputs = document.querySelectorAll('.column-filter');
        filterInputs.forEach(input => {
            input.addEventListener('input', filterTable);
        });
        filterTable(); // Initial filter run

        // Attach table button listeners using event delegation
        const rulesContainer = document.getElementById('rulesContainer');
        if(rulesContainer){
            rulesContainer.addEventListener('click', function(event) {
                const target = event.target;
                // Find the closest row, then the button with data-rule-id within that row
                const row = target.closest('tr');
                const buttonWithId = row ? row.querySelector('[data-rule-id]') : null;
                const ruleId = buttonWithId ? buttonWithId.getAttribute('data-rule-id') : null;

                if (!ruleId) return; // Ignore clicks not on buttons within a rule row

                if (target.classList.contains('edit-btn')) {
                    if (target.classList.contains('center-edit-btn')) {
                        editCenterRule(ruleId);
                    } else {
                        editRule(ruleId);
                    }
                } else if (target.classList.contains('delete-btn')) {
                     if (target.classList.contains('center-delete-btn')) {
                        deleteCenterRule(ruleId);
                    } else {
                        deleteRule(ruleId);
                    }
                }
            });
        } else {
             console.error("Element with ID 'rulesContainer' not found.");
        }


        // Setup tag inputs in the modal
        setupTagInput('keywordInput', 'keywordTags');
        setupTagInput('excludeKeywordInput', 'excludeKeywordTags');
        setupTagInput('centerExcludeKeywordInput', 'centerExcludeKeywordTags');

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeEditor();
            }
        });

        // Initial setup for fields based on default rule type
        toggleRuleFields();
    });

    // --- Table Filtering ---
    function filterTable() {
        const filters = Array.from(document.querySelectorAll('.column-filter')).map(input => ({
            table: input.closest('table'),
            column: Array.from(input.closest('tr').children).indexOf(input.closest('th')), // Get column index
            value: input.value.toLowerCase()
        }));

        document.querySelectorAll('tbody').forEach(tbody => {
            const table = tbody.closest('table');
            const tableFilters = filters.filter(f => f.table === table);
            const rows = tbody.getElementsByTagName('tr');

            for (let row of rows) {
                let showRow = true;
                tableFilters.forEach(filter => {
                     // Check if the column index is valid for the current row
                    if (filter.value && row.cells[filter.column]) {
                        const cellText = row.cells[filter.column].textContent.toLowerCase();
                        if (!cellText.includes(filter.value)) {
                            showRow = false;
                        }
                    } else if (filter.value && filter.column >= row.cells.length) {
                         // Handle case where filter column index might be out of bounds for a row (shouldn't happen with correct HTML)
                        console.warn("Filter column index out of bounds for row:", filter.column, row);
                    }
                });
                row.style.display = showRow ? '' : 'none';
            }
        });
    }


    // --- Modal Show/Hide/Reset ---
    function showAddForm() {
        editingRuleId = null; // Ensure we are in 'add' mode
        document.getElementById('modalTitle').textContent = 'Add New Rule';
        resetForm();
        document.getElementById('ruleId').disabled = false; // Allow editing ID for new rules
        document.getElementById('ruleEditor').style.display = 'block';
        document.getElementById('ruleId').focus();
    }

    function closeEditor() {
        const modal = document.getElementById('ruleEditor');
         if (modal) {
            modal.style.display = 'none';
         }
         resetForm();
    }

    function resetForm() {
        document.getElementById('ruleType').value = 'keyword';
        document.getElementById('ruleId').value = '';
        document.getElementById('ruleId').disabled = false; // Re-enable for adding
        document.getElementById('description').value = '';
        document.getElementById('addDays').value = '';
        document.getElementById('enabled').checked = true;

        // Keyword fields
        document.getElementById('keywordTags').innerHTML = '';
        document.getElementById('keywordInput').value = '';
        document.getElementById('excludeKeywordTags').innerHTML = '';
        document.getElementById('excludeKeywordInput').value = '';
        document.getElementById('matchType').value = 'any';
        document.getElementById('conditionsContainer').innerHTML = '';

        // Center fields
        document.getElementById('centerId').value = '';
        document.getElementById('centerExcludeKeywordTags').innerHTML = '';
        document.getElementById('centerExcludeKeywordInput').value = '';

        toggleRuleFields(); // Ensure correct fields are shown
    }

    // Toggle visibility of keyword/center specific fields based on dropdown
    function toggleRuleFields() {
        const type = document.getElementById('ruleType').value;
        const isKeyword = type === 'keyword';
        document.getElementById('keywordFields').style.display = isKeyword ? 'block' : 'none';
        document.getElementById('conditionsSection').style.display = isKeyword ? 'block' : 'none';
        document.getElementById('centerFields').style.display = !isKeyword ? 'block' : 'none';
    }

    // --- Populate Modal for Editing ---
    function populateModal(rule, ruleType) {
        resetForm(); // Start clean
        editingRuleId = rule.id; // Set editing mode

        document.getElementById('ruleType').value = ruleType;
        document.getElementById('ruleId').value = rule.id;
        document.getElementById('ruleId').disabled = true; // Don't allow editing ID
        document.getElementById('description').value = rule.description || '';
        document.getElementById('addDays').value = rule.addDays !== undefined ? rule.addDays : ''; // Handle potential undefined
        document.getElementById('enabled').checked = rule.enabled !== false; // Default to true if undefined/null

        if (ruleType === 'keyword') {
            document.getElementById('matchType').value = rule.matchType || 'any';
            (rule.keywords || []).forEach(kw => addTagElement(kw, 'keywordTags'));
            (rule.excludeKeywords || []).forEach(kw => addTagElement(kw, 'excludeKeywordTags'));
            loadConditionsToModal(rule.conditions); // Load conditions
        } else { // Center Rule
            document.getElementById('centerId').value = rule.centerId || '';
            (rule.excludeKeywords || []).forEach(kw => addTagElement(kw, 'centerExcludeKeywordTags'));
        }

        toggleRuleFields(); // Ensure correct sections are visible
        document.getElementById('ruleEditor').style.display = 'block';
        document.getElementById('description').focus(); // Focus description field
    }

    function editRule(ruleId) {
        const rule = currentRules.keywordRules.find(r => r.id === ruleId);
        if (rule) {
            populateModal(rule, 'keyword');
        } else {
            console.error('Keyword rule not found:', ruleId);
            alert(`Error: Keyword rule with ID "${ruleId}" not found.`);
        }
    }

    function editCenterRule(ruleId) {
        const rule = currentRules.centerRules.find(r => r.id === ruleId);
        if (rule) {
            populateModal(rule, 'center');
        } else {
            console.error('Center rule not found:', ruleId);
             alert(`Error: Center rule with ID "${ruleId}" not found.`);
        }
    }

     // --- Condition Management ---
    function addConditionRow() {
        const container = document.getElementById('conditionsContainer');
        const row = document.createElement('div');
        row.className = 'condition-row';
        row.innerHTML = `
            <select class="condition-type form-control">
                <option value="">-- Select Condition --</option>
                <option value="quantityLessThan">Quantity Less Than (<)</option>
                <option value="quantityGreaterThan">Quantity Greater Than (>)</option>
                <option value="quantityGreaterOrEqual">Quantity Greater/Equal (>=)</option>
                <option value="productIdEqual">Product ID Equals (=)</option>
                <option value="productIdNotEqual">Product ID Not Equals (!=)</option>
                <option value="productIdIn">Product ID In List (comma-sep)</option>
                <option value="productGroupNotContains">Product Group Not Contains</option>
                <option value="productionHubIs">Production Hub Is (comma-sep)</option> {# <<< ADDED OPTION #}
                <!-- Add hubOverrides editing later if needed -->
            </select>
            <input type="text" class="condition-value form-control" placeholder="Value">
            <button type="button" onclick="this.closest('.condition-row').remove()" class="delete-btn">Remove</button>
        `;
        container.appendChild(row);
    }

    function loadConditionsToModal(conditions) {
        const container = document.getElementById('conditionsContainer');
        container.innerHTML = ''; // Clear existing

        if (!conditions || typeof conditions !== 'object') return;

        for (const [key, value] of Object.entries(conditions)) {
             if (key === 'hubOverrides') continue; // Skip hubOverrides for now

            const row = document.createElement('div');
            row.className = 'condition-row';

            let valueString = value;
            let typeValue = key; // Default type value is the key

            // Adjust valueString for array types
            if (key === 'productIdIn' && Array.isArray(value)) {
                valueString = value.join(',');
            } else if (key === 'productionHubIs' && Array.isArray(value)) { // <<< ADDED BLOCK
                valueString = value.join(',');
            }

            // Build the select options dynamically, selecting the correct one
            const selectOptions = `
                 <option value="">-- Select Condition --</option>
                 <option value="quantityLessThan" ${key === 'quantityLessThan' ? 'selected' : ''}>Quantity Less Than (<)</option>
                 <option value="quantityGreaterThan" ${key === 'quantityGreaterThan' ? 'selected' : ''}>Quantity Greater Than (>)</option>
                 <option value="quantityGreaterOrEqual" ${key === 'quantityGreaterOrEqual' ? 'selected' : ''}>Quantity Greater/Equal (>=)</option>
                 <option value="productIdEqual" ${key === 'productIdEqual' ? 'selected' : ''}>Product ID Equals (=)</option>
                 <option value="productIdNotEqual" ${key === 'productIdNotEqual' ? 'selected' : ''}>Product ID Not Equals (!=)</option>
                 <option value="productIdIn" ${key === 'productIdIn' ? 'selected' : ''}>Product ID In List (comma-sep)</option>
                 <option value="productGroupNotContains" ${key === 'productGroupNotContains' ? 'selected' : ''}>Product Group Not Contains</option>
                 <option value="productionHubIs" ${key === 'productionHubIs' ? 'selected' : ''}>Production Hub Is (comma-sep)</option> {# <<< ADDED OPTION #}
            `;

            row.innerHTML = `
                <select class="condition-type form-control">${selectOptions}</select>
                <input type="text" class="condition-value form-control" placeholder="Value" value="${valueString}">
                <button type="button" onclick="this.closest('.condition-row').remove()" class="delete-btn">Remove</button>
            `;
            container.appendChild(row);
        }
    }

    function collectConditionsFromModal() {
        const conditions = {};
        const rows = document.querySelectorAll('#conditionsContainer .condition-row');
        let hasConditions = false;
        rows.forEach(row => {
            const type = row.querySelector('.condition-type').value;
            let value = row.querySelector('.condition-value').value.trim();

            if (type && value !== '') { // Only add if type and value are set
                 hasConditions = true;
                 if (type.includes('quantity') || type === 'productIdEqual' || type === 'productIdNotEqual') {
                    const numValue = parseInt(value, 10);
                    conditions[type] = isNaN(numValue) ? value : numValue; // Keep original value if not a number
                } else if (type === 'productIdIn') {
                    conditions[type] = value.split(',')
                                            .map(id => parseInt(id.trim(), 10))
                                            .filter(id => !isNaN(id)); // Filter out invalid numbers
                } else if (type === 'productionHubIs') { // <<< ADDED BLOCK
                     conditions[type] = value.split(',')
                                             .map(hub => hub.trim().toLowerCase()) // Trim and lowercase
                                             .filter(hub => hub); // Filter out empty strings
                } else {
                    conditions[type] = value; // Store as string (e.g., productGroupNotContains)
                }
            }
        });
        // Add back hubOverrides handling if you implement an editor for it
        return hasConditions ? conditions : null; // Return null if no conditions were added
    }


    // --- Tag Management ---
    function setupTagInput(inputId, containerId) {
        const inputElement = document.getElementById(inputId);
        if (!inputElement) return;
        // Prevent adding multiple listeners if modal is reopened
        if (inputElement.dataset.listenerAttached) return;

        const listener = function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const value = this.value.trim();
                if (value) {
                    addTagElement(value, containerId);
                    this.value = '';
                }
            }
        };
        inputElement.addEventListener('keypress', listener);
        inputElement.dataset.listenerAttached = 'true'; // Mark as attached
    }

    function addTagElement(value, containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;
        // Optional: Check for duplicates before adding
        const existingTags = Array.from(container.children).map(tag => tag.firstChild.textContent.trim());
        if (existingTags.includes(value.trim())) return;

        const tag = document.createElement('span');
        tag.className = 'tag';
        const textNode = document.createTextNode(value.trim() + ' ');
        tag.appendChild(textNode);
        const removeSpan = document.createElement('span');
        removeSpan.className = 'remove';
        removeSpan.textContent = '×'; // Multiplication sign X
        removeSpan.onclick = function() { this.parentElement.remove(); };
        tag.appendChild(removeSpan);
        container.appendChild(tag);
    }

    // Helper to get tags from a container
    const getTagsFromContainer = (containerId) => {
        const container = document.getElementById(containerId);
        if (!container) return [];
        return Array.from(container.children).map(tag =>
            tag.childNodes[0].nodeValue.trim() // Get text before the '×'
        ).filter(Boolean); // Remove empty strings
    };


    // --- Save and Delete Logic ---
    async function saveRule() {
        const type = document.getElementById('ruleType').value;
        const ruleIdInput = document.getElementById('ruleId');
        const ruleId = ruleIdInput.value.trim();
        const description = document.getElementById('description').value.trim();
        const addDaysVal = document.getElementById('addDays').value;

        // Basic Validation
        if (!ruleId) {
            alert('Rule ID is required.'); ruleIdInput.focus(); return;
        }
        if (editingRuleId === null) { // Only check for duplicates when adding
             const idExists = currentRules.keywordRules.some(r => r.id === ruleId) ||
                              currentRules.centerRules.some(r => r.id === ruleId);
             if (idExists) {
                alert(`Rule ID "${ruleId}" already exists. Please choose a unique ID.`);
                ruleIdInput.focus();
                return;
             }
        }
        if (!description) {
            alert('Description is required.'); document.getElementById('description').focus(); return;
        }
        if (addDaysVal === '' || isNaN(parseInt(addDaysVal, 10))) {
             alert('Days to Add must be a valid number.'); document.getElementById('addDays').focus(); return;
        }

        const rule = {
            id: ruleId,
            description: description,
            addDays: parseInt(addDaysVal, 10),
            enabled: document.getElementById('enabled').checked,
            // Initialize fields common to both but populated differently
            keywords: null,
            excludeKeywords: null,
            matchType: null,
            conditions: null,
            centerId: null,
            caseSensitive: false // Assuming default, add UI element if needed
        };

        if (type === 'keyword') {
            rule.keywords = getTagsFromContainer('keywordTags');
            rule.excludeKeywords = getTagsFromContainer('excludeKeywordTags');
            rule.matchType = document.getElementById('matchType').value;
            rule.conditions = collectConditionsFromModal();
            // Remove center-specific keys if they somehow got added
            delete rule.centerId;
        } else { // Center rule
            const centerIdVal = document.getElementById('centerId').value;
             if (centerIdVal === '' || isNaN(parseInt(centerIdVal, 10))) {
                 alert('Center ID must be a valid number for Center Rules.'); document.getElementById('centerId').focus(); return;
             }
            rule.centerId = parseInt(centerIdVal, 10);
            rule.excludeKeywords = getTagsFromContainer('centerExcludeKeywordTags');
            // Ensure keyword-specific keys are null or removed for center rules
            rule.keywords = null;
            rule.matchType = null;
            rule.conditions = null;
        }

        // Clean up null fields before sending if desired by backend (Pydantic handles Optional)
        // Object.keys(rule).forEach(key => rule[key] === null && delete rule[key]);

        console.log('Attempting to save rule:', JSON.stringify({ type, rule }, null, 2));

        // --- Backend Interaction ---
        try {
            const response = await fetch('/finishing-rules/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type, rule }) // Send type and rule object
            });

            if (response.ok) {
                 console.log("Save successful, reloading...");
                window.location.reload();
            } else {
                let errorMsg = `HTTP Error: ${response.status} ${response.statusText}`;
                try { const errorData = await response.json(); errorMsg = `Error saving rule: ${errorData.message || errorData.detail || response.statusText}`; } catch(e) {}
                 console.error("Save failed:", errorMsg);
                 alert(errorMsg);
            }
        } catch (error) {
            console.error('Network or other error saving rule:', error);
            alert('Network error saving rule: ' + error.message);
        }
    }

    async function deleteRule(ruleId) {
        if (!ruleId) return;
        if (confirm(`Are you sure you want to delete Keyword Rule: ${ruleId}?`)) {
             await performDelete(`/finishing-rules/delete/${ruleId}`, "keyword rule");
        }
    }
     async function deleteCenterRule(ruleId) {
         if (!ruleId) return;
         if (confirm(`Are you sure you want to delete Center Rule: ${ruleId}?`)) {
             await performDelete(`/finishing-rules/delete/${ruleId}`, "center rule");
         }
     }

     // Helper for delete fetch
     async function performDelete(url, itemType) {
         try {
            const response = await fetch(url, { method: 'POST' }); // Using POST based on your endpoint
            if (response.ok) {
                 console.log(`${itemType} deleted successfully, reloading...`);
                window.location.reload();
            } else {
                let errorMsg = `HTTP Error: ${response.status} ${response.statusText}`;
                 try { const errorData = await response.json(); errorMsg = `Error deleting ${itemType}: ${errorData.message || errorData.detail || response.statusText}`; } catch(e) {}
                 console.error("Delete failed:", errorMsg);
                 alert(errorMsg);
            }
        } catch (error) {
             console.error(`Network or other error deleting ${itemType}:`, error);
            alert(`Network error deleting ${itemType}: ` + error.message);
        }
     }

</script>
{% endblock %}