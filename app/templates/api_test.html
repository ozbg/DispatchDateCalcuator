{# File: app/templates/api_test.html #}
{% extends "base.html" %}
{% block content %}
<h2>Schedule API Test</h2>

<div class="api-test-container">
    <div class="main-layout">
        <!-- Left Column: Request & Raw Response -->
        <div class="panel-column">
            <div class="panel input-panel">
                <h3>Request Payload</h3>
                <div class="form-group form-group-inline">
                    <div>
                        <label for="timeOffset">Time Offset (Hours):</label>
                        <input type="number" id="timeOffset" value="0" class="form-control short-input">
                        <small>Enter +/- hours to simulate past/future time for cutoff check.</small>
                    </div>
                    <button onclick="runTest()" class="primary-btn">Run API Test</button>
                </div>
                <textarea id="requestPayload" class="code-area" rows="20">{
    "orderId": "TEST123",
    "misDeliversToPostcode": "4780",
    "misOrderQTY": 1000,
    "orientation": "portrait",
    "description": "250gsm gloss NV Laminate fold to DL bundles of 100",
    "printType": 1,
    "kinds": 1,
    "preflightedWidth": 90,
    "preflightedHeight": 55,
    "misCurrentHub": "nsw",
    "misCurrentHubID": 2,
    "misDeliversToState": "qld",
    "orderNotes": [],
    "additionalProductionDays": 0,
    "timeOffsetHours": 0,
    "orderPrice": 150.75
}</textarea>
            </div>

            <div class="panel result-panel">
                <h3>JSON Response</h3>
                <pre id="responseOutput" class="code-area"></pre>
            </div>
        </div>

        <!-- Right Column: Formatted Response -->
        <div class="panel-column">
            <div class="panel formatted-response-panel" id="formattedResponse" style="display: none;">
                <h3>Formatted Response</h3>
                <table class="response-table">
                    <!-- Table content generated by JS -->
                    <tbody id="formattedTableBody">
                        <!-- Example Row Structure (will be populated by JS)
                        <tr>
                            <th>Field 1</th><td id="field1">Value 1</td>
                            <th>Field 2</th><td id="field2">Value 2</td>
                        </tr>
                        -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Debug Panel -->
    <div class="debug-panel">
        <h3>Debug Messages</h3>
        <div class="debug-filter">
            <input type="text" id="debugFilter" placeholder="Filter debug messages..." class="form-control">
            <div class="level-filters">
                <label><input type="checkbox" value="debug" checked> Debug</label>
                <label><input type="checkbox" value="info" checked> Info</label>
                <label><input type="checkbox" value="warning" checked> Warning</label>
                <label><input type="checkbox" value="error" checked> Error</label>
                <button onclick="clearDebugLogs()" class="secondary-btn" style="margin-left: 1rem; padding: 0.4rem 0.8rem; font-size: 0.9em;">Clear</button>
            </div>
        </div>
        <div id="debugOutput" class="debug-content">
            <p class="placeholder-text">Debug messages will appear here after running the API test...</p>
        </div>
    </div>
</div>

<style>
    /* General Layout & Consistency */
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"; line-height: 1.5; color: #212529; background-color: #fff; }
    h2, h3 { color: #343a40; margin-bottom: 1rem; }
    h3 { font-size: 1.4em; }
    small { color: #6c757d; font-size: 0.85em; display: block; margin-top: 0.25rem; }

    .api-test-container {
        padding: 1rem;
        max-width: 1600px; /* Allow wider layout */
        margin: 20px auto;
    }

    .main-layout {
        display: flex;
        gap: 1.5rem; /* Space between columns */
        margin-bottom: 1.5rem;
        align-items: stretch; /* Make columns equal height */
    }

    .panel-column {
        flex: 1; /* Each column takes equal space */
        display: flex;
        flex-direction: column;
        gap: 1.5rem; /* Space between panels in the left column */
        min-width: 0; /* Prevent flex overflow */
    }

    .panel {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.3rem;
        padding: 1.25rem;
        display: flex; /* Use flex for internal layout */
        flex-direction: column; /* Stack elements vertically */
        flex-grow: 1; /* Allow panels to grow */
    }

    .input-panel, .result-panel, .formatted-response-panel {
         min-height: 450px; /* Set a consistent minimum height */
    }

    .code-area {
        font-family: monospace;
        font-size: 1.17em; /* Slightly smaller for more content */
        line-height: 1.4;
        padding: 0.75rem;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        background-color: #fff;
        width: 100%;
        box-sizing: border-box;
        resize: vertical;
        flex-grow: 1; /* Allow textarea/pre to fill panel */
        overflow: auto; /* Add scrollbars if needed */
        min-height: 200px; /* Ensure a minimum usable height */
    }
    pre#responseOutput { white-space: pre-wrap; word-wrap: break-word; font-size: 1.17em; } /* 30% bigger font for JSON response */


    /* Form Styles */
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; font-weight: 500; margin-bottom: 0.4rem; color: #495057; font-size: 0.9rem; }
    .form-control {
        width: 100%;
        padding: 0.5rem 0.75rem;
        font-size: 1.17rem;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        box-sizing: border-box;
        background-color: #fff;
    }
    .form-control:focus { border-color: #86b7fe; outline: 0; box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); }
    .short-input { width: 150px; display: inline-block; vertical-align: middle; margin-right: 10px;} /* Style for offset input */
    .form-group-inline {
        display: flex;
        justify-content: space-between;
        align-items: flex-start; /* Align items to the top */
        gap: 1rem;
    }
    .form-group-inline > div { /* Container for label/input/small */
        flex-grow: 1;
    }
    .form-group-inline .primary-btn {
        margin-top: 1.5rem; /* Align button roughly with input top, considering label */
        flex-shrink: 0; /* Prevent button from shrinking */
        height: fit-content; /* Adjust height */
    }

    /* Action Buttons (Removed - styles kept for reference if needed elsewhere) */
    /*
    .action-buttons {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
        padding-top: 1rem;
        border-top: 1px solid #dee2e6;
    }
    */
    .primary-btn, .secondary-btn {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
        padding-top: 1rem;
        border-top: 1px solid #dee2e6;
    }
    .primary-btn, .secondary-btn {
        padding: 0.6rem 1.2rem;
        font-size: 1em;
        font-weight: 500;
        border-radius: 0.25rem;
        cursor: pointer;
        border: none;
        transition: background-color 0.15s ease-in-out;
        text-align: center;
    }
    .primary-btn { background: #0d6efd; color: white; }
    .primary-btn:hover { background: #0b5ed7; }
    .secondary-btn { background: #6c757d; color: white; }
    .secondary-btn:hover { background: #5c636a; }

    /* Formatted Response Table (4 Columns) */
    .response-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9em; /* Adjust as needed */
        table-layout: fixed; /* Helps with column widths */
    }
    .response-table th,
    .response-table td {
        padding: 0.6rem; /* Slightly reduced padding */
        text-align: left;
        border: 1px solid #dee2e6;
        vertical-align: top; /* Align content to top */
        word-wrap: break-word; /* Wrap long content */
    }
    .response-table th {
        background-color: #e9ecef;
        font-weight: 600;
        width: 20%; /* Adjust width for labels */
    }
     .response-table td {
        width: 30%; /* Adjust width for values */
        background-color: #fff;
    }
    .response-table .hub-value { font-weight: bold; color: #0056b3; } /* Highlight hub values */
    .response-table .date-value { font-style: italic; color: #5a6268; } /* Style dates */
    .response-table .status-ok { color: #155724; font-weight: bold; }
    .response-table .status-warning { color: #856404; font-weight: bold; }
    .response-table .status-error { color: #721c24; font-weight: bold; }

    /* Debug Panel */
    .debug-panel {
        margin-top: 1.5rem;
        padding: 1.25rem;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.3rem;
    }
    .debug-filter {
        margin-bottom: 1rem;
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap; /* Allow wrapping on smaller screens */
        padding-bottom: 1rem;
        border-bottom: 1px solid #dee2e6;
    }
    .debug-filter input[type="text"] {
        flex-grow: 1; /* Allow text input to take available space */
        min-width: 200px;
    }
    .level-filters { display: flex; gap: 1rem; flex-wrap: wrap; }
    .level-filters label { display: flex; align-items: center; gap: 0.3rem; cursor: pointer; font-size: 0.9em; }
    .level-filters input[type="checkbox"] { width: 14px; height: 14px; }

    .debug-content {
        font-family: monospace;
        white-space: pre-wrap;
        word-wrap: break-word;
        padding: 1rem;
        background: #fff;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        max-height: 400px;
        overflow-y: auto;
        font-size: 1.105em; /* 30% bigger font for debug messages */
        line-height: 1.5;
    }
    .debug-content .log-entry { margin-bottom: 0.3rem; padding-bottom: 0.3rem; border-bottom: 1px dotted #eee; }
    .debug-content .log-entry:last-child { border-bottom: none; }
    .debug-content .timestamp { color: #6c757d; margin-right: 0.75rem; font-size: 0.9em; }
    .debug-content .level-debug { color: #0066cc; font-weight: bold; }
    .debug-content .level-info { color: #17a2b8; font-weight: bold; }
    .debug-content .level-warning { color: #ffc107; font-weight: bold; }
    .debug-content .level-error { color: #dc3545; font-weight: bold; }
    .debug-content .message { /* Keep message default color */ }
    .debug-content .placeholder-text { color: #6c757d; font-style: italic; }

    /* Responsive Adjustments */
    @media (max-width: 1200px) {
        .main-layout {
            flex-direction: column;
        }
        .panel-column {
             gap: 1rem; /* Reduce gap between panels when stacked */
        }
        .input-panel, .result-panel, .formatted-response-panel {
             min-height: 300px; /* Reduce min-height on smaller screens */
        }
    }
     @media (max-width: 768px) {
        h2 { font-size: 1.6em; }
        h3 { font-size: 1.2em; }
        .primary-btn, .secondary-btn { font-size: 0.9em; padding: 0.5rem 1rem; }
        .action-buttons { flex-direction: column; gap: 0.5rem; }
        .debug-filter { flex-direction: column; align-items: stretch; }
        .level-filters { justify-content: space-around; }
        .response-table th, .response-table td { padding: 0.4rem; font-size: 0.85em; }
        .code-area { font-size: 0.8em; }
    }

</style>

<script>
// --- Debug Log Functions ---
async function fetchDebugLogs() {
    try {
        const response = await fetch('/debug-logs');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const logs = await response.json();
        filterAndDisplayLogs(logs);
    } catch (error) {
        console.error('Error fetching debug logs:', error);
        const debugOutput = document.getElementById('debugOutput');
        if (debugOutput) {
             debugOutput.innerHTML = `<div class="log-entry level-error">Error fetching debug logs: ${error.message}</div>`;
        }
    }
}

function filterAndDisplayLogs(logs) {
    const debugOutput = document.getElementById('debugOutput');
    if (!debugOutput) return;

    if (!Array.isArray(logs)) {
        console.error("Received non-array data for logs:", logs);
        debugOutput.innerHTML = '<div class="log-entry level-error">Invalid log data received.</div>';
        return;
    }

    if (logs.length === 0) {
        debugOutput.innerHTML = '<p class="placeholder-text">No debug messages available...</p>';
        return;
    }

    // Get filter values
    const filterText = document.getElementById('debugFilter').value.toLowerCase();
    const enabledLevels = Array.from(document.querySelectorAll('.level-filters input:checked'))
        .map(cb => cb.value.toLowerCase());

    // Filter logs
    const filteredLogs = logs.filter(log => {
        if (!log || typeof log.level !== 'string' || typeof log.message !== 'string' || typeof log.timestamp !== 'string') {
             console.warn("Skipping invalid log entry:", log);
             return false;
        }
        const logLevelLower = log.level.toLowerCase();
        const levelMatch = enabledLevels.includes(logLevelLower);
        const textMatch = !filterText ||
            log.message.toLowerCase().includes(filterText) ||
            logLevelLower.includes(filterText) ||
            log.timestamp.toLowerCase().includes(filterText);
        return levelMatch && textMatch;
    });

    // Display filtered logs
    debugOutput.innerHTML = filteredLogs.map(log => {
        const timestamp = `<span class="timestamp">${log.timestamp}</span>`;
        const levelClass = `level-${log.level.toLowerCase()}`;
        const level = `<span class="${levelClass}">${log.level.toUpperCase()}</span>`;
        const message = escapeHtml(log.message); // Escape message content
        return `<div class="log-entry">${timestamp} ${level}: <span class="message">${message}</span></div>`;
    }).join(''); // No newline needed as divs are block elements

    // Auto-scroll to bottom
    debugOutput.scrollTop = debugOutput.scrollHeight;
}

function escapeHtml(unsafe) {
    if (unsafe === null || unsafe === undefined) return '';
    return String(unsafe)
         .replace(/&/g, "&amp;")
         .replace(/</g, "&lt;")
         .replace(/>/g, "&gt;")
         .replace(/"/g, "&quot;")
         .replace(/'/g, "&#039;");
}


// --- Clear Debug Logs Function ---
function clearDebugLogs() {
    const debugOutput = document.getElementById('debugOutput');
    if (debugOutput) {
        debugOutput.innerHTML = '<p class="placeholder-text">Debug messages cleared. Run API test to see new messages...</p>';
    }
}

// --- API Test Functions ---

// Helper function to create and append a row to the formatted table (4 columns)
function addFormattedRow(tbody, label1, value1, label2, value2, options1 = {}, options2 = {}) {
    const tr = document.createElement('tr');

    const th1 = document.createElement('th');
    th1.textContent = label1;
    tr.appendChild(th1);

    const td1 = document.createElement('td');
    td1.innerHTML = formatValue(value1, options1); // Use innerHTML for potential styling
    tr.appendChild(td1);

    // Only add second pair if label2 is provided
    if (label2 !== null && label2 !== undefined) {
        const th2 = document.createElement('th');
        th2.textContent = label2;
        tr.appendChild(th2);

        const td2 = document.createElement('td');
        td2.innerHTML = formatValue(value2, options2); // Use innerHTML for potential styling
        tr.appendChild(td2);
    } else {
        // If no second pair, add empty cells to maintain structure (or use colspan on first TD)
         const th2 = document.createElement('th'); tr.appendChild(th2); // Empty header
         const td2 = document.createElement('td'); tr.appendChild(td2); // Empty data
         // Alternative: td1.colSpan = 3; // If you prefer colspan
    }

    tbody.appendChild(tr);
}

// Helper to format values (handles arrays, nulls, and applies styling classes)
function formatValue(value, options = {}) {
    let displayValue = value ?? 'N/A'; // Default for null/undefined
    let cssClass = '';

    if (Array.isArray(value)) {
        displayValue = value.length > 0 ? value.join(', ') : 'N/A';
    }

    // Apply specific styling classes based on options
    if (options.isHub) cssClass = 'hub-value';
    if (options.isDate) cssClass = 'date-value';
    if (options.isStatus) { // Example status styling
        const lowerVal = String(displayValue).toLowerCase();
        if (lowerVal.includes('ok') || lowerVal.includes('passed') || lowerVal === 'true') cssClass = 'status-ok';
        else if (lowerVal.includes('warning') || lowerVal.includes('adjusted')) cssClass = 'status-warning';
        else if (lowerVal.includes('fail') || lowerVal.includes('error') || lowerVal === 'false') cssClass = 'status-error';
    }

    // Escape HTML before wrapping in span (if class exists)
    const escapedValue = escapeHtml(displayValue);
    return cssClass ? `<span class="${cssClass}">${escapedValue}</span>` : escapedValue;
}


async function runTest() {
    const responseOutput = document.getElementById('responseOutput');
    const formattedDiv = document.getElementById('formattedResponse');
    const formattedTableBody = document.getElementById('formattedTableBody');
    const requestPayloadEl = document.getElementById('requestPayload');
    const timeOffsetInput = document.getElementById('timeOffset');

    // Clear previous results
    if(responseOutput) responseOutput.textContent = 'Running test...';
    if(formattedDiv) formattedDiv.style.display = 'none';
    if(formattedTableBody) formattedTableBody.innerHTML = ''; // Clear table body

    try {
        const offsetValue = parseInt(timeOffsetInput.value) || 0;
        let payload;
        try {
            payload = JSON.parse(requestPayloadEl.value);
        } catch (e) {
            throw new Error(`Invalid JSON in Request Payload: ${e.message}`);
        }
        payload.timeOffsetHours = offsetValue;

        const response = await fetch('/schedule', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const result = await response.json();
        const formattedResult = JSON.stringify(result, null, 2);

        if(responseOutput) responseOutput.textContent = formattedResult;

        if (!response.ok) {
            let detail = result.detail || response.statusText;
            if (typeof detail === 'object') {
                detail = JSON.stringify(detail);
            }
            throw new Error(`API Error ${response.status}: ${detail}`);
        }

        // Update formatted table only on success
        if(formattedDiv) formattedDiv.style.display = 'block';
        if(formattedTableBody) {
            // --- Populate Formatted Table (4 Columns) ---
            addFormattedRow(formattedTableBody, 'Order ID', result.orderId, 'Product ID', result.productId, {}, { isHub: true });
            addFormattedRow(formattedTableBody, 'Description', result.orderDescription, 'Product Group', result.productGroup, {}, { isHub: true });
            addFormattedRow(formattedTableBody, 'Current Hub', result.currentHub, 'Current Hub ID', result.currentHubId, { isHub: true });
            addFormattedRow(formattedTableBody, 'Order Postcode', result.orderPostcode, 'Product Category', result.productCategory);
            addFormattedRow(formattedTableBody, 'Preflight Width', result.preflightedWidth, 'Preflight Height', result.preflightedHeight);
            addFormattedRow(formattedTableBody, 'Order Qty', result.orderQuantity, 'Order Kinds', result.orderKinds);
            addFormattedRow(formattedTableBody, 'Total Quantity', result.totalQuantity, 'Order Price', result.orderPrice);
            addFormattedRow(formattedTableBody, 'Grain Direction', result.grainDirection, 'Production Hubs', result.productionHubs);

            // Separator or empty row for visual grouping (optional)
            // addFormattedRow(formattedTableBody, '', '', '', '');

            addFormattedRow(formattedTableBody, 'Chosen Hub', result.chosenProductionHub, 'Hub Transfer To', result.hubTransferTo, { isHub: true }, { isHub: true });
            addFormattedRow(formattedTableBody, 'Cutoff Status', result.cutoffStatus, 'Product Cutoff', result.productCutoff, { isStatus: true });
            addFormattedRow(formattedTableBody, 'Base Prod Days', result.daysToProduceBase, 'Finishing Days', result.finishingDays);
            addFormattedRow(formattedTableBody, 'Product Start Days', result.productStartDays, 'Total Prod Days', result.totalProductionDays, {}, { isHub: true }); // Highlight total days
            addFormattedRow(formattedTableBody, 'Production Groups', result.productionGroups, null, null); // Span full row if needed

            // Dates
            addFormattedRow(formattedTableBody, 'Actual Proc. Time', result.actualProcessingTime, 'Simulated Proc. Time', result.simulatedProcessingTime, { isDate: true }, { isDate: true });
            addFormattedRow(formattedTableBody, 'Start Date (Initial)', result.startDate, 'Adj. Start Date', result.adjustedStartDate, { isDate: true }, { isDate: true });
            addFormattedRow(formattedTableBody, 'Dispatch Date', result.dispatchDate, null, null, { isDate: true, isHub: true }); // Highlight dispatch date

            // Config
            addFormattedRow(formattedTableBody, 'Synergy Preflight', result.synergyPreflight, 'Synergy Impose', result.synergyImpose, { isStatus: true }, { isStatus: true });
            addFormattedRow(formattedTableBody, 'Auto Hub Transfer', result.enableAutoHubTransfer, null, null, { isStatus: true });
            // --- End Populate Table ---
        }

    } catch (error) {
        console.error('API Test Error:', error);
        if(responseOutput) responseOutput.textContent = 'Error: ' + error.message;
        if(formattedDiv) formattedDiv.style.display = 'none';
    } finally {
        await fetchDebugLogs();
    }
}

// --- Initialization ---
document.addEventListener('DOMContentLoaded', function() {
    const debugFilter = document.getElementById('debugFilter');
    const levelFilters = document.querySelectorAll('.level-filters input');

    if (debugFilter) {
        debugFilter.addEventListener('input', fetchDebugLogs);
    }
    levelFilters.forEach(checkbox => {
        checkbox.addEventListener('change', fetchDebugLogs);
    });

    fetchDebugLogs(); // Initial fetch
});

</script>
{% endblock %}