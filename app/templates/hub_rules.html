{% extends "base.html" %}
{% block content %}
<h2>Hub Selection Rules Management</h2>
<p><a href="/" class="btn">Back to Admin</a></p>
<p><a href="/" class="btn">Back to Admin</a></p>

<div class="help-section">
    <h3>Understanding Hub Selection Rules</h3>
    <div class="rule-explanation">
        <div class="rule-box">
            <h4>Rule Application</h4>
            <p>Rules only remove hubs from the available list when constraints are not met</p>
            <p class="example">Example: If a hub exceeds size limits, it's removed as an option</p>
        </div>
        <div class="rule-box">
            <h4>Hub Selection</h4>
            <p>After applying rules, system tries to:</p>
            <ol>
                <li>Use current hub if still valid</li>
                <li>Fall back to remaining valid hubs</li>
            </ol>
        </div>
        <div class="rule-box">
            <h4>Constraints</h4>
            <ul>
                <li>Size and quantity limits</li>
                <li>Equipment availability</li>
                <li>Temporary restrictions</li>
                <li>Product requirements</li>
            </ul>
        </div>
    </div>
</div>

<button onclick="showAddForm()" class="add-btn">Add New Rule</button>

<div id="rulesContainer" class="rules-container">
    <table class="rules-table">
        <thead>
            <tr>
                <th>Priority</th>
                <th>Hub</th>
                <th>Description</th>
                <th>Constraints</th>
                <th>Status</th>
                <th>Valid Until</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="hubRulesBody">
            {% if rules %}
                {% for rule in rules %}
                <tr>
                    <td>{{ rule.priority }}</td>
                    <td>{{ rule.hubId }}</td>
                    <td>{{ rule.description }}</td>
                    <td>
                        <ul class="constraints-list">
                            {% if rule.sizeConstraints %}
                            <li>Max size: {{ rule.sizeConstraints.maxWidth }}x{{ rule.sizeConstraints.maxHeight }}
                                {% if rule.sizeConstraints.maxQuantity %}
                                    (Max Qty: {{ rule.sizeConstraints.maxQuantity }})
                                {% endif %}
                            </li>
                            {% endif %}
                            
                            {% if rule.keywords %}
                            <li>Required Keywords: {{ rule.keywords|join(", ") }}</li>
                            {% endif %}
                            
                            {% if rule.excludeKeywords %}
                            <li>Excluded Keywords: {{ rule.excludeKeywords|join(", ") }}</li>
                            {% endif %}
                            
                            {% if rule.productIds %}
                            <li>Product IDs: {{ rule.productIds|join(", ") }}</li>
                            {% endif %}
                            
                            {% if rule.productGroups %}
                            <li>Product Groups: {{ rule.productGroups|join(", ") }}</li>
                            {% endif %}
                            
                            {% if rule.requiredEquipment %}
                            <li>Required Equipment: {{ rule.requiredEquipment|join(", ") }}</li>
                            {% endif %}
                            
                            {% if rule.requiredProcesses %}
                            <li>Required Processes: {{ rule.requiredProcesses|join(", ") }}</li>
                            {% endif %}
                        </ul>
                    </td>
                    <td>{{ "Active" if rule.enabled else "Disabled" }}</td>
                    <td>{{ rule.endDate if rule.endDate else "Permanent" }}</td>
                    <td>
                        <button onclick="editRule('{{ rule.id }}')" class="edit-btn">Edit</button>
                        <button onclick="deleteRule('{{ rule.id }}')" class="delete-btn">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="7">No rules found. Click 'Add New Rule' to create one.</td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<!-- Rule Editor Modal -->
<div id="ruleEditor" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">Edit Hub Rule</h3>
        
        <div class="form-group">
            <label for="ruleId">Rule ID:</label>
            <input type="text" id="ruleId" required>
        </div>

        <div class="form-group">
            <label for="description">Description:</label>
            <input type="text" id="description" required>
        </div>

        <div class="form-group">
            <label for="hubId">Production Hub:</label>
            <select id="hubId" required>
                <option value="vic">Victoria</option>
                <option value="qld">Queensland</option>
                <option value="nsw">New South Wales</option>
            </select>
        </div>

        <div class="form-group">
            <label for="priority">Priority:</label>
            <input type="number" id="priority" value="0">
        </div>

        <div class="form-group">
            <h4>Size Constraints</h4>
            <div class="size-constraints">
                <label>Max Width (mm):
                    <input type="number" id="maxWidth" step="0.1">
                </label>
                <label>Max Height (mm):
                    <input type="number" id="maxHeight" step="0.1">
                </label>
                <label>Max Quantity:
                    <input type="number" id="maxQuantity">
                </label>
            </div>
        </div>

        <div class="form-group">
            <h4>Keywords</h4>
            <div class="keywords-section">
                <div>
                    <label>Required Keywords:</label>
                    <div class="tag-input-container">
                        <input type="text" id="keywordInput" placeholder="Type and press Enter">
                        <div id="keywordTags" class="tag-container"></div>
                    </div>
                </div>
                <div>
                    <label>Excluded Keywords:</label>
                    <div class="tag-input-container">
                        <input type="text" id="excludeKeywordInput" placeholder="Type and press Enter">
                        <div id="excludeKeywordTags" class="tag-container"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-group">
            <h4>Product Restrictions</h4>
            <div class="product-restrictions">
                <div>
                    <label>Product IDs:</label>
                    <div class="tag-input-container">
                        <input type="text" id="productIdInput" placeholder="Enter product ID">
                        <div id="productIdTags" class="tag-container"></div>
                    </div>
                </div>
                <div>
                    <label>Product Groups:</label>
                    <div class="tag-input-container">
                        <input type="text" id="productGroupInput" placeholder="Enter product group">
                        <div id="productGroupTags" class="tag-container"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-group">
            <h4>Time Restrictions</h4>
            <div class="time-restrictions">
                <label>Start Date:
                    <input type="date" id="startDate">
                </label>
                <label>End Date:
                    <input type="date" id="endDate">
                </label>
            </div>
        </div>

        <div class="form-group">
            <label>
                <input type="checkbox" id="enabled" checked>
                Rule Enabled
            </label>
        </div>

        <div class="button-group">
            <button onclick="saveRule()" class="save-btn">Save Rule</button>
            <button onclick="closeEditor()" class="cancel-btn">Cancel</button>
        </div>
    </div>
</div>

<style>
/* Existing styles from finishing_rules.html */
.tag-input-container {
    margin-top: 0.5rem;
}

.tag {
    display: inline-block;
    background: #e9ecef;
    border-radius: 4px;
    padding: 2px 8px;
    margin: 2px 4px;
    font-size: 0.9em;
}

.tag .remove {
    margin-left: 6px;
    cursor: pointer;
    color: #666;
}

.tag .remove:hover {
    color: #dc3545;
}

.tag-container {
    min-height: 32px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    padding: 4px;
    margin-top: 4px;
}
.rules-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

/* Add hub-specific styles */
.size-constraints,
.time-restrictions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 0.5rem;
}

.keywords-section,
.product-restrictions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-top: 0.5rem;
}

.constraints-list {
    margin: 0;
    padding-left: 20px;
    font-size: 0.9em;
}

/* Include all other styles from finishing_rules.html */
</style>

<script>
// Store rules in a JS variable
let currentRules = {{ rules|tojson }};

function showAddForm() {
    document.getElementById('modalTitle').textContent = 'Add New Hub Rule';
    resetForm();
    document.getElementById('ruleEditor').style.display = 'block';
}

function closeEditor() {
    document.getElementById('ruleEditor').style.display = 'none';
    resetForm();
}

function resetForm() {
    document.getElementById('ruleId').value = '';
    document.getElementById('description').value = '';
    document.getElementById('hubId').value = 'vic';
    document.getElementById('priority').value = '0';
    document.getElementById('maxWidth').value = '';
    document.getElementById('maxHeight').value = '';
    document.getElementById('maxQuantity').value = '';
    document.getElementById('keywordTags').innerHTML = '';
    document.getElementById('excludeKeywordTags').innerHTML = '';
    document.getElementById('productIdTags').innerHTML = '';
    document.getElementById('productGroupTags').innerHTML = '';
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    document.getElementById('enabled').checked = true;
}

function editRule(ruleId) {
    const rule = currentRules.find(r => r.id === ruleId);
    if (!rule) return;

    document.getElementById('modalTitle').textContent = 'Edit Hub Rule';
    document.getElementById('ruleId').value = rule.id;
    document.getElementById('description').value = rule.description;
    document.getElementById('hubId').value = rule.hubId;
    document.getElementById('priority').value = rule.priority;
    document.getElementById('enabled').checked = rule.enabled;

    // Load size constraints
    if (rule.sizeConstraints) {
        document.getElementById('maxWidth').value = rule.sizeConstraints.maxWidth;
        document.getElementById('maxHeight').value = rule.sizeConstraints.maxHeight;
        document.getElementById('maxQuantity').value = rule.sizeConstraints.maxQuantity || '';
    }

    // Load keywords
    if (rule.keywords) {
        rule.keywords.forEach(kw => addTag(kw, 'keywordTags'));
    }
    if (rule.excludeKeywords) {
        rule.excludeKeywords.forEach(kw => addTag(kw, 'excludeKeywordTags'));
    }

    // Load product restrictions
    if (rule.productIds) {
        rule.productIds.forEach(id => addTag(id.toString(), 'productIdTags'));
    }
    if (rule.productGroups) {
        rule.productGroups.forEach(group => addTag(group, 'productGroupTags'));
    }

    // Load dates
    document.getElementById('startDate').value = rule.startDate || '';
    document.getElementById('endDate').value = rule.endDate || '';

    document.getElementById('ruleEditor').style.display = 'block';
}

async function saveRule() {
    try {
        // Generate a unique ID if not editing
        const ruleId = document.getElementById('ruleId').value || 'rule_' + Date.now();

        // Validate required fields
        const description = document.getElementById('description').value;
        const hubId = document.getElementById('hubId').value;
        
        async function saveRule() {
    try {
        // Validate required fields
        const description = document.getElementById('description').value;
        const hubId = document.getElementById('hubId').value;
        
        if (!description || !hubId) {
            alert('Description and Production Hub are required');
            return;
        }

        // Generate a unique ID if not editing
        const ruleId = document.getElementById('ruleId').value || 'rule_' + Date.now();

        // Build the rule object
        const rule = {
            id: ruleId,
            description: description,
            hubId: hubId,
            priority: parseInt(document.getElementById('priority').value || '0'),
            enabled: document.getElementById('enabled').checked
        };

        // Add size constraints if any values exist
        const maxWidth = document.getElementById('maxWidth').value;
        const maxHeight = document.getElementById('maxHeight').value;
        const maxQuantity = document.getElementById('maxQuantity').value;
        
        if (maxWidth || maxHeight || maxQuantity) {
            rule.sizeConstraints = {
                maxWidth: maxWidth ? parseFloat(maxWidth) : null,
                maxHeight: maxHeight ? parseFloat(maxHeight) : null,
                maxQuantity: maxQuantity ? parseInt(maxQuantity) : null
            };
        }

        // Add keywords if they exist
        const keywords = Array.from(document.getElementById('keywordTags').children)
            .map(tag => tag.firstChild.textContent.trim())
            .filter(kw => kw);
        if (keywords.length > 0) {
            rule.keywords = keywords;
        }

        const excludeKeywords = Array.from(document.getElementById('excludeKeywordTags').children)
            .map(tag => tag.firstChild.textContent.trim())
            .filter(kw => kw);
        if (excludeKeywords.length > 0) {
            rule.excludeKeywords = excludeKeywords;
        }

        // Add product restrictions if they exist
        const productIds = Array.from(document.getElementById('productIdTags').children)
            .map(tag => parseInt(tag.firstChild.textContent.trim()))
            .filter(id => !isNaN(id));
        if (productIds.length > 0) {
            rule.productIds = productIds;
        }

        const productGroups = Array.from(document.getElementById('productGroupTags').children)
            .map(tag => tag.firstChild.textContent.trim())
            .filter(group => group);
        if (productGroups.length > 0) {
            rule.productGroups = productGroups;
        }

        // Add dates if they exist
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        if (startDate) rule.startDate = startDate;
        if (endDate) rule.endDate = endDate;

        console.log('Saving rule:', rule);

        const response = await fetch('/hub-rules/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(rule)
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();

        if (result.success) {
            window.location.reload();
        } else {
            throw new Error(result.message || 'Failed to save rule');
        }
    } catch (error) {
        console.error('Save error:', error);
        alert('Error saving rule: ' + error.message);
    }
}

async function deleteRule(ruleId) {
    if (!confirm('Are you sure you want to delete this rule?')) {
        return;
    }

    try {
        const response = await fetch(`/hub-rules/delete/${ruleId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        
        if (result.success) {
            window.location.reload();
        } else {
            throw new Error(result.message || 'Failed to delete rule');
        }
    } catch (error) {
        console.error('Delete error:', error);
        alert('Error deleting rule: ' + error.message);
    }
}

function editRule(ruleId) {
    const rule = currentRules.find(r => r.id === ruleId);
    if (!rule) {
        console.error('Rule not found:', ruleId);
        return;
    }

    document.getElementById('modalTitle').textContent = 'Edit Hub Rule';
    
    // Reset form first
    resetForm();
    
    // Fill in basic fields
    document.getElementById('ruleId').value = rule.id;
    document.getElementById('description').value = rule.description;
    document.getElementById('hubId').value = rule.hubId;
    document.getElementById('priority').value = rule.priority || 0;
    document.getElementById('enabled').checked = rule.enabled !== false;

    // Fill in size constraints
    if (rule.sizeConstraints) {
        document.getElementById('maxWidth').value = rule.sizeConstraints.maxWidth || '';
        document.getElementById('maxHeight').value = rule.sizeConstraints.maxHeight || '';
        document.getElementById('maxQuantity').value = rule.sizeConstraints.maxQuantity || '';
    }

    // Fill in keywords
    if (rule.keywords && Array.isArray(rule.keywords)) {
        rule.keywords.forEach(kw => addTag(kw, 'keywordTags'));
    }
    if (rule.excludeKeywords && Array.isArray(rule.excludeKeywords)) {
        rule.excludeKeywords.forEach(kw => addTag(kw, 'excludeKeywordTags'));
    }

    // Fill in product IDs and groups
    if (rule.productIds && Array.isArray(rule.productIds)) {
        rule.productIds.forEach(id => addTag(id.toString(), 'productIdTags'));
    }
    if (rule.productGroups && Array.isArray(rule.productGroups)) {
        rule.productGroups.forEach(group => addTag(group, 'productGroupTags'));
    }

    // Fill in dates
    if (rule.startDate) document.getElementById('startDate').value = rule.startDate;
    if (rule.endDate) document.getElementById('endDate').value = rule.endDate;

    document.getElementById('ruleEditor').style.display = 'block';
}

    // Add size constraints if values exist
    const maxWidth = document.getElementById('maxWidth').value;
    const maxHeight = document.getElementById('maxHeight').value;
    const maxQuantity = document.getElementById('maxQuantity').value;
    
    if (maxWidth || maxHeight || maxQuantity) {
        rule.sizeConstraints = {
            maxWidth: maxWidth ? parseFloat(maxWidth) : null,
            maxHeight: maxHeight ? parseFloat(maxHeight) : null,
            maxQuantity: maxQuantity ? parseInt(maxQuantity) : null
        };
    }

    // Add keywords if they exist
    const keywords = Array.from(document.getElementById('keywordTags').children)
        .map(tag => tag.firstChild.textContent.trim());
    if (keywords.length > 0) {
        rule.keywords = keywords;
    }

    const excludeKeywords = Array.from(document.getElementById('excludeKeywordTags').children)
        .map(tag => tag.firstChild.textContent.trim());
    if (excludeKeywords.length > 0) {
        rule.excludeKeywords = excludeKeywords;
    }

    // Add product restrictions if they exist
    const productIds = Array.from(document.getElementById('productIdTags').children)
        .map(tag => parseInt(tag.firstChild.textContent.trim()))
        .filter(id => !isNaN(id));
    if (productIds.length > 0) {
        rule.productIds = productIds;
    }

    const productGroups = Array.from(document.getElementById('productGroupTags').children)
        .map(tag => tag.firstChild.textContent.trim());
    if (productGroups.length > 0) {
        rule.productGroups = productGroups;
    }

    // Add dates if they exist
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (startDate) {
        rule.startDate = startDate;
    }
    if (endDate) {
        rule.endDate = endDate;
    }

    console.log('Saving rule:', rule);

    try {
        const response = await fetch('/hub-rules/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(rule)
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();

        if (result.success) {
            window.location.reload();
        } else {
            alert('Error saving rule: ' + result.message);
        }
    } catch (error) {
        console.error('Error saving rule:', error);
        alert('Error saving rule: ' + error.message);
    }
}
}

async function deleteRule(ruleId) {
    if (!ruleId || !confirm('Are you sure you want to delete this rule?')) {
        return;
    }

    try {
        const response = await fetch(`/hub-rules/delete/${ruleId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            window.location.reload();
        } else {
            alert('Error deleting rule: ' + result.message);
        }
    } catch (error) {
        console.error('Delete error:', error);
        alert('Error deleting rule: ' + error.message);
    }
}

function editRule(ruleId) {
    const rule = currentRules.find(r => r.id === ruleId);
    if (!rule) {
        console.error('Rule not found:', ruleId);
        return;
    }

    document.getElementById('modalTitle').textContent = 'Edit Hub Rule';
    
    // Reset form first
    resetForm();
    
    // Fill in basic fields
    document.getElementById('ruleId').value = rule.id;
    document.getElementById('description').value = rule.description;
    document.getElementById('hubId').value = rule.hubId;
    document.getElementById('priority').value = rule.priority || 0;
    document.getElementById('enabled').checked = rule.enabled !== false;

    // Fill in size constraints
    if (rule.sizeConstraints) {
        document.getElementById('maxWidth').value = rule.sizeConstraints.maxWidth || '';
        document.getElementById('maxHeight').value = rule.sizeConstraints.maxHeight || '';
        document.getElementById('maxQuantity').value = rule.sizeConstraints.maxQuantity || '';
    }

    // Fill in keywords
    if (rule.keywords && Array.isArray(rule.keywords)) {
        rule.keywords.forEach(kw => addTag(kw, 'keywordTags'));
    }
    if (rule.excludeKeywords && Array.isArray(rule.excludeKeywords)) {
        rule.excludeKeywords.forEach(kw => addTag(kw, 'excludeKeywordTags'));
    }

    // Fill in product IDs and groups
    if (rule.productIds && Array.isArray(rule.productIds)) {
        rule.productIds.forEach(id => addTag(id.toString(), 'productIdTags'));
    }
    if (rule.productGroups && Array.isArray(rule.productGroups)) {
        rule.productGroups.forEach(group => addTag(group, 'productGroupTags'));
    }

    // Fill in dates
    if (rule.startDate) document.getElementById('startDate').value = rule.startDate;
    if (rule.endDate) document.getElementById('endDate').value = rule.endDate;

    document.getElementById('ruleEditor').style.display = 'block';
}
// Tag input functionality
function addTag(value, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;

    const tag = document.createElement('span');
    tag.className = 'tag';
    
    const cleanValue = value.trim();
    const textNode = document.createTextNode(cleanValue);
    tag.appendChild(textNode);

    const removeBtn = document.createElement('span');
    removeBtn.className = 'remove';
    removeBtn.innerHTML = '&times;';
    removeBtn.onclick = function() {
        tag.remove();
    };

    tag.appendChild(removeBtn);
    container.appendChild(tag);
}

// Handle tag input events
['keywordInput', 'excludeKeywordInput', 'productIdInput', 'productGroupInput'].forEach(inputId => {
    document.getElementById(inputId).addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && this.value.trim()) {
            const containerMap = {
                'keywordInput': 'keywordTags',
                'excludeKeywordInput': 'excludeKeywordTags',
                'productIdInput': 'productIdTags',
                'productGroupInput': 'productGroupTags'
            };
            
            addTag(this.value.trim(), containerMap[this.id]);
            this.value = '';
            e.preventDefault();
        }
    });
});
</script>
{% endblock %}